## Dell G16 7630 Optimizing

### Prelude

I recently purchased a [Dell G16](https://www.amazon.com/Dell-Gaming-i9-13900HX-24-Core-GeForce/dp/B0CL6J6HGR) laptop from Dell directly.

Between the deal that was on at the time and a 10% reduction I negotiated post-sale (due to an even better sale that started no long after I bought),
I ended up with a very capable medium-high tier performance laptop for quite a good price by my estimate.  
Not including sales tax and the $89 extended 3 year support I bought, it came to approximately $1327.00.

My specs are here:

* Dell G16 7630 model
* Processor	13th (Raptor Lake) Gen Intel(R) Core(TM) i9-13900HX  2.20 GHz (base clock), *5.4Ghz (turbo)*, *24 cores* + HT: 8 performance cores w/ HT, 16 efficiency cores
* Installed RAM	32.0 GB 4800 MT/s
* *Nvidia GeForce RTX 4070* (mobile) discrete GPU w/ 8GB dedicated GDDR6 RAM (128-bit bus)
* Intel UHD graphics (built-in) using Optimus to switch between
* 1TB PCIe NVMe SSD (M.2, half length)
* Cherry RGB per key *mechanical* keyboard
* 6-cell, 86 WHr, Lithium-ion Battery
* QHD+ 2560 x 1600 240Hz 16" display

That said, I'm partially paying for it in another area, **thermals**!

I'm used to buying large, heavy, and hot performance laptops.  
However, I was not prepared for how hot the G16 can get.

The first, very strong evidence of this was simply turning it on for the first time.
I thought it was fine to do this on a flat surface (no passive or active cooling/riser stand which I normally use).
I was very wrong.  Within a few minutes of turning it on, and *doing nothing*, the system became like the surface of the sun.
To the point I was concerned there was a problem specifically with the machine I got since it was already super hot just from essentially idling.

Thus began my struggle to cool this raging inferno of a laptop.

Turns out, the Intel 13th generation Raptor Lake i9's are crazy hot, and, for the K* and potentialy other series, [unstable at higher clock speeds](https://www.tomshardware.com/pc-components/cpus/dev-reports-that-intels-laptop-cpus-are-also-crashing-several-laptops-have-suffered-similar-crashes-in-testing).
This latter issue doesn't seem to be a problem for my machine I think, though I have noticed a few freezes/unexpected reboots.
Though, that appears to have stopped happening once I re-installed windows (10 instead of 11, which was the factory default).

My strong suspicion, partially borne out by further tweaking and testing, is that the Intel 13900HX is the main culprit:

* its # of cores (24)
* high turbo clock speed (5.4Ghz)
* reports of super hot laptops using it and general instability (likely due at least in part to heat) on the Raptor Lake processors

The first 2 bullets are based on the CPU vs. GPU temperature sensor readings 
and the fact that the Nvidia 4070 GPU doesn't even get used until switched to by Optimus when a GPU-using application is started.

That said, if I ignore the thermals (heat and fan noise) for a moment, I love this laptop!
I'm not a shill for Dell either---I'm not getting any kind of revenue from this post in any way at this point---having owned both Dell/Alienware *and* MSI laptops over the last several years, I think I can say a thing or two about higher-end laptops, at least between these two brands.

First, there's the performance.  
The high speed/efficient CPU cores and the capabilities of the RTX 4070 combined, make for a formidable  machine in portable form.
This is rounded out with 2 PCIe M.2 slots and 32GBs of RAM right out of the box.

Then there's the Cherry mechanical keyboard, which I'm typing on right now to write this.  Best keyboard on a laptop I've had in a few years!

Also, I was surprised to see people complaining that Dell threw in a 330W power brick, while heavy and large, this seems great for the power this machine
may need to pull.

Ironically, I remember getting an Alienware 17 R2 back in 2015 which *only* had a 180W brick and people complained about that as well!

Finally, I was suprised that I actually like the somewhat unsual white with black and purple highlights of the color scheme rather than the normal black + othercolor highlights that's typical.

### Phase 1: Taking Control of Fans and Clock Speeds

I've been on a journey (as alluded to above) to quell the heat as much as possible in this machine.
I've divided this progression into phases, with Phase 1 being the easiest to do (no extra $$ required, just time and the internet/research).

The first thing I wanted to do was lower the clock speeds on all the cores during normal (not CPU/GPU intensive) usage
This is especially needed for the performance cores, since they can get up to nearly 5.4GHz while the efficiency cores only to 3.9Ghz max.
The key program here was ThrottleStop, which gives very granular control over all kinds of CPU-related performance settings (depending on what's unlocked by the manufacturer).  

Regrettably, Dell did *not* unlock the voltage for the CPU, so undervolting was out, but I was able to dynamically adjust the clock speeds of all the cores down as much as I wanted.  I started by dropping them to 4GHz which helped.  I know there are more extreme ways of getting around the voltage lock, but I'd rather avoid those if I can for now (maybe I'll try and cover them in a future post).

I then sought to get control of the fans.  This is an annoying subject since it seems like Dell doesn't make easy fan control available by default, or at least I missed it initially.  I tried some of the other free, 3rd party fan control software out there to no avail.  It might be simply that I didn't take enough time to learn how to configure them, but what I could see, they weren't detecting any fans on the G16.

That said, I was able to get control by installing the latest Alienware Command Center [AWCC](https://www.dell.com/support/home/en-us/product-support/product/alienware-command-center/overview) and discovering it does have a manual fan control mode for the CPU fan, which I proceeded to set to 100% all the time (same with the GPU fan for good measure) via the `Custom` profile.  

<img width="587" alt="awcc_custom_settings_thermalside" src="https://github.com/user-attachments/assets/38b8281a-2d02-4a4c-aeaa-e731dd2a6ab2">

I should note this does end up with an annoying full fan noise which I'm willing to live with if it means lower temperatures.  That said, as I'm writing this I have the fans set to `Performance` mode which keeps them both around ~50% and temperatures are ~55 and ~43 celsius (CPU and GPU respectively).

<img width="802" alt="awcc_performance_nongaming_cool" src="https://github.com/user-attachments/assets/7298b2ca-5640-4487-8780-360a90b5fef6">

I will give Dell partial props for the AWCC, it does have both an informative interface and allows some amount of customization (mainly for the fans).  It does also allow one to reduce the maximum clock speed though only down to 4.9Ghz from 5.4Ghz.  Why it can't go lower I have no idea!

<img width="552" alt="awcc_custom_settings_perfside_minimum" src="https://github.com/user-attachments/assets/6ae312ba-6618-4e1f-8e81-1f8b4dce10fe">


That said, [ThrottleStop](https://www.techpowerup.com/download/techpowerup-throttlestop/) (v9.6) is the right tool to adjust the clock speed while also supporting profiles as well.

<img width="421" alt="throttlestop_main0" src="https://github.com/user-attachments/assets/28d6ac63-3a5d-428c-ba2c-87c8f81c96a5">


I went to the FIVR tab and under Turbo Groups reduced all performance cores down to < 4Ghz (more on this later).
ThrottleStop can be configured to print a readable form of the 1) CPU clock speed and 2) CPU temperature in the system tray which I found handy as well.

<img width="711" alt="throttlestop_FIVR_battery0" src="https://github.com/user-attachments/assets/8fa397f4-2d7f-42c3-9e3b-8079850ec74d">

Further, I used [HWiNFO64](https://www.hwinfo.com/download/) v8.04-5470 to monitor temperatures.  While optional given that ThrottleStop and AWCC will both report some form of temperature for the CPUs at least, I found HWiNFO's layout and extensive readings, as well as the charting ability very useful.

<img width="763" alt="hwinfo64_awcctest54ghz_normalcooling_4graphs1" src="https://github.com/user-attachments/assets/2bbeafc3-d2b9-4881-a9a7-bc99370c427b">

#### Hiding Cores from the OS in the BIOS

Another aspect I pursued was disabling cores in the BIOS, what this does is essentially hide the cores from the OS, so it can't schedule threads on them.
That doesn't mean they're not contributing to the heat still in some form, but at least their usage will be 0 and therefore keep their heat from increasing.  I ended up keeping the 8 performance cores enabled, while hiding the 16 efficiency cores, since I reasoned they'd be less useful for for the performance intensive tasks I had in mind, but still contribute to the total heat.  This can be done under the "Performance" section of the default Dell BIOS (efficiency cores are called "Atom" cores here).

#### Order of Loading

AWCC and ThrottleStop will conflict with each other if both are used at the same time.  Since each will leave their settings active when closed (which is useful).  So be aware of this, but using AWCC *first* to set the fans appropriately, usually either custom to get full fans or performance profile to get 50% fans.  Then close AWCC and load ThrottleStop and set your desired CPU frequency/speed (e.g. 3Ghz).

Even idling/writing this via Github online editor, the machine is still hotter than I'd like plugged in.  It's running 55-60 celsius for the CPU temp with the fan ~45% for < 2.2Ghz clock speeds with all efficiency cores disabled in the BIOS.

#### Intel Raptor Lake CPU Instability Issues

Recently there's been a lot of reports going around on Youtube and elsewhere (e.g. Tom's Hardware) about instability problems with Intel 13th and 14th generation Raptor lake CPUs.  Mainly these appear to affect desktop based models with the K* suffix, which are typically used for overclocking.  However, in a very recent acknowledgement by Intel, apparently these issues can also crop up with processors pulling 65 watts or above, not just the K* branded ones.  

While laptop processors typically pull less power than their desktop counterparts, given the heat issues I've been seeing with my 13th generation raptor lake processor on my G16 (13900HX), I thought I'd run one of the stability tests mentioned here.

The "test" as reported was to run a recent verion of the Nvidia driver installer package repeatedly until it errored out (e.g. 5-10 times in a row).  Apparently, the decompression required by the installer package uses enough of the CPU to likely [trigger the instability](https://www.radgametools.com/oodleintel.htm), though this is not always true(?).

I ran the Nvidia full driver (express mode) installation of `560.70-notebook-win10-win11-64bit-international-dch-whql` driver 6 times on my G16 and saw no errors.  This doesn't necessarily prove there aren't any, but it gives me some relief that nothing immiediately failed.  I also monitored the wattage pull from my CPU using HWiNFO64 and while the CPU does spike above 65W from time to time it mostly stays quite a bit under (e.g. 40-50W or less).  So I suspect there's just not enough wattage pull here to really trigger the issue, that and my laptop was manufactored in ~June 2024, so maybe Intel had already fixed these processors by that time (or earlier).
